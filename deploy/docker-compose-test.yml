version: "2.2"
networks:
  database:
  caching:

volumes:
  mysql:
  
services:
  app:
    image: wrestlingdev
    build:
      context: ../
      dockerfile: ./deploy/rails-prod-Dockerfile
    environment:
      - RAILS_ENV=production
      - WRESTLINGDEV_DB_NAME=wrestlingtourney
      - WRESTLINGDEV_DB_USR=root
      - WRESTLINGDEV_DB_PWD=password
      - WRESTLINGDEV_DB_HOST=db
      - WRESTLINGDEV_DB_PORT=3306
      - MEMCACHIER_SERVERS=memcached:11211
      - MEMCACHIER_PASSWORD=
    networks:
      database:
      caching:
    restart: always
    ports:
      - "80:80"
      - "443:443"
    healthcheck: 
      test: curl http://127.0.0.1/

  db:
    image: mysql:5.7
    ports:
      - "3306:3306"
    volumes:
      - mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=password
    restart: always
    networks:
      database:

  worker:
    image: wrestlingdev
    environment:
      - RAILS_ENV=production
      - WRESTLINGDEV_DB_NAME=wrestlingtourney
      - WRESTLINGDEV_DB_USR=root
      - WRESTLINGDEV_DB_PWD=password
      - WRESTLINGDEV_DB_HOST=db
      - WRESTLINGDEV_DB_PORT=3306
      - MEMCACHIER_SERVERS=memcached:11211
      - MEMCACHIER_PASSWORD=
    networks:
      database:
      caching:
    restart: always
    command: bundle exec bin/delayed_job -n 1 run

  memcached:
    image: memcached:1.5
    mem_limit: 64000000
    restart: always
    networks:
      caching:

